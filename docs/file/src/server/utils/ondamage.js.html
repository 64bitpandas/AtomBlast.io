<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/server/utils/ondamage.js | atomblast.io</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="First attempt at multiplayer online io game"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="atomblast.io"><meta property="twitter:description" content="First attempt at multiplayer online io game"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/BananiumLabs/AtomBlast.io.git"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-js">client/js</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bindHandler">bindHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-displayWinner">displayWinner</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hideElement">hideElement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-quitGame">quitGame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-showElement">showElement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateAtomList">updateAtomList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateCompoundButtons">updateCompoundButtons</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateLobby">updateLobby</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateScores">updateScores</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-distanceBetween">distanceBetween</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateID">generateID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCurrTile">getCurrTile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getGlobalLocation">getGlobalLocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isInBounds">isInBounds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createPlayer">createPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-destroyPIXI">destroyPIXI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getIngame">getIngame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isFocused">isFocused</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadTextures">loadTextures</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mouseDownHandler">mouseDownHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mouseUpHandler">mouseUpHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-movePlayer">movePlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setIngame">setIngame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-showGameUI">showGameUI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-startGame">startGame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-beginConnection">beginConnection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-disconnect">disconnect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-cookieInputs">cookieInputs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-joystick">joystick</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-selectedBlueprints">selectedBlueprints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-selectedCompound">selectedCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GLOBAL">GLOBAL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mouseDown">mouseDown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-objects">objects</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-teamColors">teamColors</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-js-lib">client/js/lib</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/lib/chat-client.js~ChatClient.html">ChatClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/lib/mobilejoystick.js~VirtualJoystick.html">VirtualJoystick</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eraseCookie">eraseCookie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCookie">getCookie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setCookie">setCookie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-keyboard">keyboard</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-js-obj">client/js/obj</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/obj/damageindicator.js~DamageIndicator.html">DamageIndicator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/obj/gameobject.js~GameObject.html">GameObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/obj/maptile.js~MapTile.html">MapTile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/obj/player.js~Player.html">Player</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createPlayer">createPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createRenderAtom">createRenderAtom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createRenderCompound">createRenderCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createTiles">createTiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-requestCreateCompound">requestCreateCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BLUEPRINTS">BLUEPRINTS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MAP_LAYOUT">MAP_LAYOUT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TILES">TILES</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TILE_NAMES">TILE_NAMES</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server">server</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deleteObject">deleteObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getField">getField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-incrementField">incrementField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setField">setField</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-utils">server/utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-canCraft">canCraft</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-incrementAtom">incrementAtom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-spawnAtom">spawnAtom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-spawnAtomAtVent">spawnAtomAtVent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-collisionDetect">collisionDetect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createCompound">createCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-tickCompound">tickCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addExperience">addExperience</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-frameSync">frameSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-roomMatchmaker">roomMatchmaker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-damage">damage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-damageTile">damageTile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splash">splash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initGlobal">initGlobal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initPlayer">initPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTeamColors">getTeamColors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTeamNumber">getTeamNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTileID">getTileID</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/server/utils/ondamage.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { GLOBAL } from &apos;../../client/js/global&apos;
import { getField, setField, incrementField } from &apos;../server&apos;
import { getTeamNumber } from &apos;./serverutils&apos;
import { tmpdir } from &apos;os&apos;
import { spawnAtom } from &apos;./atoms&apos;

/**
 * ondamage.js
 * Contains functions:
 *  - damage() Runs when a player gets damaged. Updates scores and checks if a player has been killed.
 *  - splash() Runs when a collision needs to cause splash damage. Creates explosion effect and deals extra damage.
 */

/**
 * Changes the health of the player by the amount given.
 * @param {*} data The data sent by the client. Contains:
 *  - damage (number)
 *  - player (id string of player that was hit)
 *  - id (id string of compound)
 *  - sentBy (id string of player that sent compound)
 * @param {string} room This room.
 * @param {*} socket This socket.
 * Must include the player id and amount to damage.
 * Amount may be negative (for health boost).
 */
export function damage (data, room, socket) {
	let thisRoom = getField([&apos;rooms&apos;, room])
	let thisPlayer = thisRoom.players[data.player]

	if (thisPlayer !== undefined) {
		// thisPlayer.health -= data.damage;
		if (data.damage &gt; thisPlayer.shield) {
			setField(thisPlayer.health - data.damage + thisPlayer.shield, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;health&apos;])
			// Send damage indicator data
			socket.emit(&apos;serverSendDamageIndicator&apos;, {
				damage: data.damage - thisPlayer.shield,
				posX: thisPlayer.posX,
				posY: thisPlayer.posY
			})
		}
		else {
			socket.emit(&apos;serverSendDamageIndicator&apos;, {
				damage: 0,
				posX: thisPlayer.posX,
				posY: thisPlayer.posY
			})
		}

		// Add damage to database
		if (thisPlayer.damagedBy[data.sentBy] === undefined) {
			setField(0, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;damagedBy&apos;, data.sentBy])
		}
		// thisPlayer.damagedBy[data.sentBy] += data.damage;
		setField(thisPlayer.damagedBy[data.sentBy] + data.damage, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;damagedBy&apos;, data.sentBy])

		// Check if the player has died.
		if (thisPlayer.health &lt;= 0) {
			// console.log(thisRoom.teams.indexOf(socket.handshake.query.team));

			// Releases atoms and deletes the entire atoms array in player
			for (let at in thisPlayer.atomList) {
				for (let i = 0; i &lt; GLOBAL.MAX_DEATH_ATOMS &amp;&amp; i &lt; thisPlayer.atomList[at]; i++) {
					spawnAtom(thisPlayer.posX, thisPlayer.posY, at, room, false)
				}
			}
			for (let at in thisPlayer.atomList) {
				setField(0, [&apos;rooms&apos;, room, &apos;players&apos;, thisPlayer, &apos;atomList&apos;, at])
			}

			// Set defense to 0
			setField(0, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;shield&apos;])

			// Reset position to spawnpoint
			setField(GLOBAL.SPAWN_POINTS[getTeamNumber(room, thisPlayer.team)].x * GLOBAL.GRID_SPACING * 2, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;posX&apos;])
			setField(GLOBAL.SPAWN_POINTS[getTeamNumber(room, thisPlayer.team)].y * GLOBAL.GRID_SPACING * 2, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;posY&apos;])
			setField(GLOBAL.MAX_HEALTH, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;health&apos;])
			setField(true, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;dead&apos;]) // This will be reset when it has been verified that the player has been placed at the proper spawnpoint

			// Send player death info to client
			if (socket.id === data.player) {
				let pl = getField([&apos;rooms&apos;, room, &apos;players&apos;, data.player])
				socket.emit(&apos;serverSendPlayerDeath&apos;, { posX: pl.posX, posY: pl.posY, vx: pl.vx, vy: pl.vy })

				// Announce death. TODO make some cool messages
				socket.emit(&apos;serverAnnouncement&apos;, {
					message: pl.name + &apos; was obliterated by &apos; + getField([&apos;rooms&apos;, room, &apos;players&apos;, data.sentBy, &apos;name&apos;]),
					sendingTeam: pl.team
				})
				socket.to(room).emit(&apos;serverAnnouncement&apos;, {
					message: pl.name + &apos; was obliterated by &apos; + getField([&apos;rooms&apos;, room, &apos;players&apos;, data.sentBy, &apos;name&apos;]),
					sendingTeam: pl.team
				})

				// Check if the nucleus has died
				if (getField([&apos;rooms&apos;, room, &apos;tiles&apos;, &apos;n&apos; + getTeamNumber(room, pl.team), &apos;captured&apos;])) {
					// Announce final death
					socket.emit(&apos;serverAnnouncement&apos;, {
						message: &apos;FINAL KILL!!!&apos;,
						sendingTeam: pl.team
					})
					socket.to(room).emit(&apos;serverAnnouncement&apos;, {
						message: &apos;FINAL KILL!!!&apos;,
						sendingTeam: pl.team
					})

					setField(true, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;spectating&apos;])
				}
			}

			// Check if a team was eliminated
			if (data.id !== undefined) {
				for (let team of getField([&apos;rooms&apos;, room, &apos;teams&apos;])) {
					// console.log(team)
					if (!team.dead) {
						let stillAlive = false
						for (let player of team.players) {
							if (!getField([&apos;rooms&apos;, room, &apos;players&apos;, player, &apos;spectating&apos;])) {
								stillAlive = true
							}
						}
						if (!stillAlive) {
							// Announce elimination of team
							team.dead = true
							socket.to(room).emit(&apos;serverAnnouncement&apos;, {
								message: team.name + &apos; has been eliminated!&apos;,
								sendingTeam: team.name
							})
							socket.emit(&apos;serverAnnouncement&apos;, {
								message: team.name + &apos; has been eliminated!&apos;,
								sendingTeam: team.name
							})

							// Check if a team has won
							let deadCount = 0
							let notDeadTeam = null
							for (let team of getField([&apos;rooms&apos;, room, &apos;teams&apos;])) {
								if (team.dead) {
									deadCount++
								}
								else {
									notDeadTeam = team.name
								}
							}

							console.log(deadCount)
							console.log(notDeadTeam)

							// A team has won!
							if (deadCount === getField([&apos;rooms&apos;, room, &apos;teams&apos;]).length - 1) {
								let dataToSend = {
									winner: notDeadTeam
									// teamScore: thisRoom.teams[dataToSend.teamSlot].score
									// other data here TODO post ranking
								}
								socket.to(room).broadcast.emit(&apos;serverSendWinner&apos;, dataToSend)
								socket.emit(&apos;serverSendWinner&apos;, dataToSend)
							}
						}
					}
				}
			}
			// // Award points (TODO)_
			// if (data.id !== undefined) {
			// 	// Read damagedBy to award points, clear in the process
			// 	let max = null
			// 	let dataToSend
			// 	for (let pl in thisPlayer.damagedBy) {
			// 		dataToSend = {
			// 			player: pl,
			// 			teamSlot: getTeamNumber(room, thisRoom.compounds[data.id].sendingTeam),
			// 			increment: GLOBAL.ASSIST_SCORE,
			// 			kill: false
			// 		}

			// 		// Add to team score, checking if team score is initialized
			// 		setField((thisRoom.teams[dataToSend.teamSlot].score === undefined) ? dataToSend.increment : thisRoom.teams[dataToSend.teamSlot].score + dataToSend.increment, [&apos;rooms&apos;, room, &apos;teams&apos;, dataToSend.teamSlot, &apos;score&apos;])

			// 		socket.to(room).broadcast.emit(&apos;serverSendScoreUpdate&apos;, dataToSend)
			// 		socket.emit(&apos;serverSendScoreUpdate&apos;, dataToSend)
			// 		if (max === null || thisPlayer.damagedBy[pl] &gt; thisPlayer.damagedBy[max]) {
			// 			max = pl
			// 		}
			// 	}

			// 	// Add to score of person who dealt the most damage
			// 	dataToSend.player = max
			// 	dataToSend.increment = GLOBAL.KILL_SCORE - GLOBAL.ASSIST_SCORE
			// 	dataToSend.kill = true
			// 	socket.to(room).broadcast.emit(&apos;serverSendScoreUpdate&apos;, dataToSend)
			// 	socket.emit(&apos;serverSendScoreUpdate&apos;, dataToSend)

			// 	// Add to team score
			// 	incrementField(dataToSend.increment, [&apos;rooms&apos;, room, &apos;teams&apos;, dataToSend.teamSlot, &apos;score&apos;])

			// 	// Clear damagedBy values
			// 	for (let pl in thisPlayer.damagedBy) {
			// 		setField(0, [&apos;rooms&apos;, room, &apos;players&apos;, data.player, &apos;damagedBy&apos;, pl])
			// 	}

			// 	// Check if a team won
			// 	let highScores = [] // Possible winning teams
			// 	let maxScore = 0
			// 	for (let tm of thisRoom.teams) {
			// 		if (tm.score &gt;= GLOBAL.WINNING_SCORE) {
			// 			highScores.push(tm)
			// 			if (maxScore &lt; tm.score) {
			// 				maxScore = tm.score
			// 			}
			// 		}
			// 	}
			// 	for (let winningTm of highScores) {
			// 		if (winningTm.score === maxScore) {
			// 			let dataToSend = {
			// 				winner: winningTm
			// 				// teamScore: thisRoom.teams[dataToSend.teamSlot].score
			// 				// other data here TODO post ranking
			// 			}
			// 			socket.to(room).broadcast.emit(&apos;serverSendWinner&apos;, dataToSend)
			// 			socket.emit(&apos;serverSendWinner&apos;, dataToSend)

			// 			// Close room after delay (kick all players)
			// 			setTimeout(() =&gt; {
			// 				socket.emit(&apos;serverSendDisconnect&apos;, {})
			// 				socket.to(room).broadcast.emit(&apos;serverSendDisconnect&apos;, {})
			// 			}, GLOBAL.ROOM_DELETE_DELAY)
			// 		}
			// 	}
			// }
		}
	}
	else {
		console.warn(&apos;Player of ID &apos; + data.player + &apos; couldn\&apos;t be damaged because they don\&apos;t exist!&apos;)
	}
}

export function damageTile (tileID, damageAmount, player, room, socket) {
	incrementField(-damageAmount, [&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;health&apos;])

	// console.log(&apos;tile &apos; + tileID + &apos; is now at &apos; + getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;health&apos;]))
	let hpData = {
		newHealth: getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;health&apos;]),
		tileX: getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;globalX&apos;]),
		tileY: getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;globalY&apos;])
	}
	socket.to(room).emit(&apos;serverSendTileHealth&apos;, hpData)
	socket.emit(&apos;serverSendTileHealth&apos;, hpData)

	// Check if tile is fully captured
	if (getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;health&apos;]) &lt;= 0) {
		for (let i = 0; i &lt; 3; i++) {
			if (getField([&apos;rooms&apos;, room, &apos;teams&apos;, i]).name === getField([&apos;rooms&apos;, room, &apos;players&apos;, player, &apos;team&apos;])) {
				// Notify clients of texture change
				let data = {
					teamNumber: i,
					tileX: getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;globalX&apos;]),
					tileY: getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;globalY&apos;])
				}
				socket.to(room).emit(&apos;serverSendTileCapture&apos;, data)
				socket.emit(&apos;serverSendTileCapture&apos;, data)
				let tileCaptureMSG = {
					message: &apos;A &apos; + getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;type&apos;]) + &apos; has been captured by &apos; + getField([&apos;rooms&apos;, room, &apos;players&apos;, player, &apos;name&apos;]),
					sendingTeam: getField([&apos;rooms&apos;, room, &apos;players&apos;, player, &apos;team&apos;])
				}
				socket.to(room).emit(&apos;serverAnnouncement&apos;, tileCaptureMSG)
				socket.emit(&apos;serverAnnouncement&apos;, tileCaptureMSG)

				// Set capture status
				setField(true, [&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;captured&apos;])
				setField(getField([&apos;rooms&apos;, room, &apos;players&apos;, player, &apos;team&apos;]), [&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;owner&apos;])

				// Distribute points
				incrementField(GLOBAL.CAPTURE_SCORE, [&apos;rooms&apos;, room, &apos;teams&apos;, i, &apos;score&apos;])

				// Reset health
				setField(GLOBAL[(&apos;MAX_&apos; + getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;type&apos;]) + &apos;_HEALTH&apos;).toUpperCase()], [&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;health&apos;])
				let hpData = {
					newHealth: getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;health&apos;]),
					tileX: getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;globalX&apos;]),
					tileY: getField([&apos;rooms&apos;, room, &apos;tiles&apos;, tileID, &apos;globalY&apos;])
				}
				socket.to(room).emit(&apos;serverSendTileHealth&apos;, hpData)
				socket.emit(&apos;serverSendTileHealth&apos;, hpData)
				return true
			}
		}
	}
}

/**
 * TODO
 */
export function splash () {

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
