<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/server/server.js | atomblast.io</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="First attempt at multiplayer online io game"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="atomblast.io"><meta property="twitter:description" content="First attempt at multiplayer online io game"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/BananiumLabs/AtomBlast.io.git"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-js">client/js</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bindHandler">bindHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-displayWinner">displayWinner</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hideElement">hideElement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-quitGame">quitGame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-showElement">showElement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateAtomList">updateAtomList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateCompoundButtons">updateCompoundButtons</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateLobby">updateLobby</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateScores">updateScores</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-distanceBetween">distanceBetween</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateID">generateID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCurrTile">getCurrTile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getGlobalLocation">getGlobalLocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isInBounds">isInBounds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createPlayer">createPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-destroyPIXI">destroyPIXI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getIngame">getIngame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isFocused">isFocused</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadTextures">loadTextures</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mouseDownHandler">mouseDownHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mouseUpHandler">mouseUpHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-movePlayer">movePlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setIngame">setIngame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-showGameUI">showGameUI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-startGame">startGame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-beginConnection">beginConnection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-disconnect">disconnect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-cookieInputs">cookieInputs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-joystick">joystick</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-selectedBlueprints">selectedBlueprints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-selectedCompound">selectedCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GLOBAL">GLOBAL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mouseDown">mouseDown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-objects">objects</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-teamColors">teamColors</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-js-lib">client/js/lib</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/lib/chat-client.js~ChatClient.html">ChatClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/lib/mobilejoystick.js~VirtualJoystick.html">VirtualJoystick</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eraseCookie">eraseCookie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCookie">getCookie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setCookie">setCookie</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-keyboard">keyboard</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-js-obj">client/js/obj</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/obj/damageindicator.js~DamageIndicator.html">DamageIndicator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/obj/gameobject.js~GameObject.html">GameObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/obj/maptile.js~MapTile.html">MapTile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/js/obj/player.js~Player.html">Player</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createPlayer">createPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createRenderAtom">createRenderAtom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createRenderCompound">createRenderCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createTiles">createTiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-requestCreateCompound">requestCreateCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BLUEPRINTS">BLUEPRINTS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MAP_LAYOUT">MAP_LAYOUT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TILES">TILES</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TILE_NAMES">TILE_NAMES</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server">server</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deleteObject">deleteObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getField">getField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-incrementField">incrementField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setField">setField</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-utils">server/utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-canCraft">canCraft</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-incrementAtom">incrementAtom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-spawnAtom">spawnAtom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-spawnAtomAtVent">spawnAtomAtVent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-collisionDetect">collisionDetect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createCompound">createCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-tickCompound">tickCompound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addExperience">addExperience</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-frameSync">frameSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-roomMatchmaker">roomMatchmaker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-damage">damage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-damageTile">damageTile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splash">splash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initGlobal">initGlobal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initPlayer">initPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTeamColors">getTeamColors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTeamNumber">getTeamNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTileID">getTileID</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/server/server.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const express = require(&apos;express&apos;)
const app = express()
const http = require(&apos;http&apos;).Server(app)
const io = require(&apos;socket.io&apos;)(http)
import colors from &apos;colors&apos; // Console colors :D
import { GLOBAL } from &apos;../client/js/global&apos;
import { roomMatchmaker } from &apos;./utils/matchmaker&apos;
import { initGlobal, initPlayer } from &apos;./utils/serverinit&apos;
import { frameSync } from &apos;./utils/framesync&apos;
import { damage } from &apos;./utils/ondamage&apos;
import { createCompound } from &apos;./utils/compound&apos;
import { spawnAtomAtVent } from &apos;./utils/atoms&apos;
import { getTeamColors } from &apos;./utils/serverutils&apos;
var config = require(&apos;./config.json&apos;)

const DEBUG = true

app.use(express.static(`${__dirname}/../client`))

/* Contains all game data, including which rooms and players are active.
 *
 * Structure of Rooms object:
 *
// rooms = {
//     roomName: {
//         joinable: true,
//         type: &apos;4v4&apos;,
//         teams: [
//             name: &apos;teamname&apos;,
//             players: [&apos;id1&apos;, &apos;id2&apos;...],
//			   dead: false
//         ],
//         players: { id, name, room, team, health, posX, posY, vx, vy, dead, experience, damagedBy, stronghold, defense, spectating },
//         atoms: { typeID, id, posX, posY, vx, vy, team },
//         compounds: {	id, posX, posY, vx, vy, blueprint, sendingTeam, sender },
//		   tiles: { id, type, globalX, globalY, captured, owner, health }
//         time: {
//             minutes: 0,
//             seconds: 0,
//             formattedTime: &apos;0:00&apos;
//         }
//     }
// }
*/
let rooms = {}

/**
 * Teams object containing all the currently playing teams.
 * Structure:
 * teamName: {
 *    room: &apos;roomName&apos;,
 *    players: [&apos;playerSocketId&apos;, &apos;player2SocketId&apos;, ...],
 *    joinable: false/true
 * }
 *
 * -&gt; Create a Team when the first player joins any lobby. Populate room when this occurs.
 * -&gt; Change joinable to false when a Team is either full or the game has begun.
 * -&gt; Delete the room from the database when the last player leaves.
 * -&gt; There cannot be two teams with the same name. Throw an error if this occurs.
 */
let teams = {}

// Initializize Server. Includes atom spawning and timer mechanics
initGlobal()

// Initialize all socket listeners when a request is established
io.on(&apos;connection&apos;, socket =&gt; {
	// Local variable declaration
	let room = socket.handshake.query.room
	let team = socket.handshake.query.team

	// Run matchmaker
	let matchData = roomMatchmaker(socket, room, team)
	room = matchData.room
	team = matchData.team

	// Init player
	initPlayer(socket, room, team)
	let thisPlayer = rooms[room].players[socket.id]
	thisPlayer.team = team
	thisPlayer.atomList = {}
	thisPlayer.speedMult = 1
	for (let atom of GLOBAL.ATOM_IDS) {
		thisPlayer.atomList[atom] = 0
	}

	// Announce colors
	socket.emit(&apos;serverSendTeamColors&apos;, getTeamColors(room))
	socket.to(room).emit(&apos;serverSendTeamColors&apos;, getTeamColors(room))

	// Setup player array sync- once a frame
	setInterval(() =&gt; {
		frameSync(socket, room, thisPlayer)
	}, 1000 / 60)

	// Receives a chat from a player, then broadcasts it to other players
	socket.to(room).on(&apos;playerChat&apos;, data =&gt; {
		// console.log(&apos;sender: &apos; + data.sender);
		const _sender = data.sender.replace(/(&lt;([^&gt;]+)&gt;)/ig, &apos;&apos;)
		const _message = data.message.replace(/(&lt;([^&gt;]+)&gt;)/ig, &apos;&apos;)

		console.log(&apos;[CHAT] &apos;.bold.blue + `${(new Date()).getHours()}:${(new Date()).getMinutes()} ${_sender}: ${_message}`.magenta)

		socket.to(room).broadcast.emit(&apos;serverSendPlayerChat&apos;, { sender: _sender, message: _message.substring(0, 35), sendingTeam: data.sendingTeam })
	})

	// Other player joins the socket.to(room)
	socket.to(room).on(&apos;playerJoin&apos;, data =&gt; {
		// console.log(&apos;sender: &apos; + data.sender);
		const _sender = data.sender.replace(/(&lt;([^&gt;]+)&gt;)/ig, &apos;&apos;)
		socket.to(room).broadcast.emit(&apos;serverSendLoginMessage&apos;, { sender: _sender, team: data.team })
		if (DEBUG) {
			socket.to(room).broadcast.emit(&apos;serverMSG&apos;, &apos;You are connected to a DEBUG enabled server. &apos;)
		}
	})

	// Broadcasts player join message

	socket.to(room).broadcast.emit(&apos;serverSendLoginMessage&apos;, {
		sender: socket.id
	})
	if (DEBUG) {
		socket.to(room).broadcast.emit(&apos;serverMSG&apos;, &apos;You are connected to a DEBUG enabled server. &apos;)
	}

	// Hides the lobby screen if the game has already started
	if (rooms[room].started) {
		socket.emit(&apos;serverSendStartGame&apos;, { teams: rooms[room].teams })
	}

	/**
   * On player movement:
   * data is in format
   *  - id: index of player that moved
   *  - type: atoms, players, or compounds
   *  - posX: new x position
   *  - posY: new y position
   *  - vx: x-velocity
   *  - vy: y-velocity
   */
	socket.to(room).on(&apos;move&apos;, data =&gt; {
		// Player exists in database already because it was created serverside - no need for extra checking
		if (rooms[room][data.type][data.id] !== undefined &amp;&amp; !rooms[room][data.type][data.id].dead) {
			rooms[room][data.type][data.id].posX = data.posX
			rooms[room][data.type][data.id].posY = data.posY
			rooms[room][data.type][data.id].vx = data.vx
			rooms[room][data.type][data.id].vy = data.vy
		}
	})

	socket.to(room).on(&apos;damage&apos;, data =&gt; {
		damage(data, room, socket)
	})

	socket.on(&apos;verifyPlayerDeath&apos;, data =&gt; {
		rooms[room].players[data.id].dead = false
	})

	// A player spawned a Compound
	socket.to(room).on(&apos;requestCreateCompound&apos;, data =&gt; {
		let newCompound = createCompound(data, room, thisPlayer, socket)
		if (newCompound) {
			rooms[room].compounds[newCompound.id] = newCompound
		}
	})

	socket.on(&apos;startGame&apos;, data =&gt; {
		console.log(&apos;Game has started in room &apos; + room)
		// Make the room and teams unjoinable
		for (let tm of rooms[room].teams) {
			teams[tm.name].joinable = false
		}
		rooms[room].joinable = false

		// Assign nucleus teams
		for (let tile in rooms[room].tiles) {
			if (rooms[room].tiles[tile].type === &apos;nucleus&apos;) {
				// console.log(rooms[room].teams)
				try {
					rooms[room].tiles[tile].owner = rooms[room].teams[parseInt(rooms[room].tiles[tile].id.substring(1))].name
				}
				catch (e) {
					// console.warn(&apos;No team exists for nucleus &apos; + rooms[room].tiles[tile].id.substring(1))
				}
			}
		}

		socket.broadcast.to(room).emit(&apos;serverSendStartGame&apos;, { start: data.start, teams: rooms[room].teams })
		socket.emit(&apos;serverSendStartGame&apos;, { start: data.start, teams: rooms[room].teams })
		rooms[room].started = true
	})

	// Testing purposes- give yourself 5000 of each atom
	socket.on(&apos;testCommand&apos;, (data) =&gt; {
		if (GLOBAL.DEBUG) {
			// console.log(rooms[room].players[data.player].atomList)
			for (let i in rooms[room].players[data.player].atomList) {
				rooms[room].players[data.player].atomList[i] += 5000
			}
		}
	})

	socket.on(&apos;disconnect&apos;, data =&gt; {
		console.log(&apos;[Server]&apos;.bold.blue + &apos; Disconnect Received: &apos;.red + (&apos;&apos; + socket.id).yellow + (&apos;&apos; + rooms[room].players[socket.id]).green + &apos;: &apos; + data)

		socket.to(room).broadcast.emit(&apos;disconnectedPlayer&apos;, { id: socket.id }) // Broadcast to everyone in the room to delete the player

		delete rooms[room].players[socket.id] // Remove the server side player

		// Delete room if there is nobody inside
		if (Object.keys(rooms[room].players).length === 0) {
			console.log(&apos;[Server] &apos;.bold.blue + &apos;Closing room &apos;.red + (room + &apos;&apos;).bold.red)
			delete io.sockets.adapter.rooms[socket.id]
			delete rooms[room]

			if (room !== GLOBAL.NO_ROOM_IDENTIFIER) {
				// Remove from teams array
				teams[team].players.splice(teams[team].players.indexOf(socket.id), 1)
				// rooms[room].teams[team].players.splice(rooms[room].teams[team].players.indexOf(socket.id), 1);

				// Delete team if all players have left
				if (teams[team].players.length === 0) {
					delete teams[team]
				}
			}
		}
	})
})

// Notify on console when server has started
const serverPort = process.env.PORT || config.port
http.listen(serverPort, () =&gt; {
	rooms = {}
	console.log(&apos;[Server] &apos;.bold.blue + `started on port: ${serverPort}`.blue)
})

/**
 * Sets a new value for a protected server field.
 * Adopted from https://stackoverflow.com/questions/18936915/dynamically-set-property-of-nested-object
 * @param {*} value The value to set
 * @param {*} path Array containing all of the subobject identifiers, with the 0th index being the lowest level.
 *                 Example: rooms.myRoom.players could be accessed through a path value of [&apos;rooms&apos;, &apos;myRoom&apos;, &apos;players&apos;]
 */
export function setField (value, path) {
	if (path === undefined || path.length === 0) {
		throw new Error(&apos;Error in setField: path cannot be empty&apos;)
	}

	let schema = (path[0] === &apos;rooms&apos;) ? rooms : (path[0] === &apos;teams&apos;) ? teams : undefined
	if (schema === undefined) {
		throw new Error(&apos;Base object &apos; + path[0] + &apos; does not exist!&apos;)
	}

	let len = path.length
	for (let i = 1; i &lt; len - 1; i++) {
		let elem = path[i]
		if (!schema[elem]) schema[elem] = {}
		schema = schema[elem]
	}

	schema[path[len - 1]] = value
}

/**
 * Shorthand to add or concatenate an amount to a field.
 * Best used with numbers or strings.
 * @param {*} amount Amount to increment the field by.
 * @param {*} path Path to the field.
 */
export function incrementField (amount, path) {
	setField(getField(path) + amount, path)
}

/**
 * Returns the value given a path to that value.
 * Adopted from https://stackoverflow.com/questions/6491463/accessing-nested-javascript-objects-with-string-key
 * @param {*} path Array containing all of the subobject identifiers, with the 0th index being the lowest level.
 *                 Example: rooms.myRoom.players could be accessed through a path value of [&apos;rooms&apos;, &apos;myRoom&apos;, &apos;players&apos;]
 * @returns The value for the given field.
 */
export function getField (path) {
	if (path === undefined || path.length === 0) {
		throw new Error(&apos;Error in setField: path cannot be empty&apos;)
	}
	if (path.length === undefined) {
		throw new Error(&apos;Error in setField: path must be an array&apos;)
	}

	let obj = (path[0] === &apos;rooms&apos;) ? rooms : (path[0] === &apos;teams&apos;) ? teams : undefined
	if (obj === undefined) {
		throw new Error(&apos;Error in setField: Base object &apos; + path[0] + &apos; does not exist!&apos;)
	}

	for (let i = 1; i &lt; path.length; i++) {
		obj = obj[path[i]]
	}
	// console.log(path, obj);
	return obj
}

/**
 * Deletes one of the three types of gameObjects synced to the server
 * @param {string} type Either players, atoms, compounds
 * @param {*} id ID of the object to delete
 * @param {string} room Room name to delete in
 * @param {*} socket socket.io instance
 */
export function deleteObject (type, id, room, socket) {
	delete rooms[room][type][id]

	// Send clientside message
	socket.to(room).broadcast.emit(&apos;serverSendObjectRemoval&apos;, { id: id, type: type })
	socket.emit(&apos;serverSendObjectRemoval&apos;, { id: id, type: type })
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
